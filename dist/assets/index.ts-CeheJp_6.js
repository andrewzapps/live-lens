const E="modulepreload",w=function(e){return"/"+e},h={},_=function(r,n,d){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(n.map(i=>{if(i=w(i),i in h)return;h[i]=!0;const l=i.endsWith(".css"),m=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${m}`))return;const t=document.createElement("link");if(t.rel=l?"stylesheet":E,l||(t.as="script"),t.crossOrigin="",t.href=i,c&&t.setAttribute("nonce",c),document.head.appendChild(t),l)return new Promise((u,y)=>{t.addEventListener("load",u),t.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${i}`)))})}))}function a(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return s.then(o=>{for(const c of o||[])c.status==="rejected"&&a(c.reason);return r().catch(a)})},f="live-lens-openai-key",g=new Map;chrome.runtime.onMessage.addListener((e,r,n)=>e.type==="LIVE_LENS_CAPTURE"?(b().then(s=>n({dataUrl:s})).catch(s=>n({error:String(s)})),!0):e.type!=="LIVE_LENS_ASK"?void 0:(A(e).then(n).catch(s=>n({error:String(s)})),!0));function b(){return chrome.tabs.captureVisibleTab({format:"png"})}chrome.commands.onCommand.addListener(e=>{e==="describe-page"&&chrome.tabs.query({active:!0,currentWindow:!0},r=>{const n=r[0];n!=null&&n.id&&chrome.tabs.sendMessage(n.id,{type:"LIVE_LENS_ACTIVATE"}).catch(()=>{})})});async function v(){return new Promise(e=>{chrome.storage.local.get([f],r=>e(r[f]||""))})}async function A(e){var i,l,m;const r=await v();if(!(r!=null&&r.trim()))return{error:"OpenAI API key not set. Open the extension popup and add your key."};const{default:n}=await _(async()=>{const{default:t}=await import("./index-bmPoTLac.js");return{default:t}},[]),d=new n({apiKey:r}),s=e.conversationId??`conv-${Date.now()}`;let a=g.get(s);a?a.messages.push({role:"user",content:p(e)}):(a={imageDataUrl:e.imageDataUrl,messages:[{role:"user",content:p(e)}]},g.set(s,a));const o={type:"image_url",image_url:{url:a.imageDataUrl}},c=[{role:"system",content:"You are a helpful assistant describing web page content from a screenshot. Answer concisely in plain English. If the user asks about a specific part (e.g. 'left side', 'the button'), focus on that. Do not dump everything; answer exactly what was asked."},...a.messages.slice(0,-1).map(t=>t.role==="user"?{role:"user",content:[{type:"text",text:t.content},o]}:{role:"assistant",content:t.content}),{role:"user",content:[{type:"text",text:a.messages[a.messages.length-1].content},o]}];try{const u=((m=(l=(i=(await d.chat.completions.create({model:"gpt-4o",messages:c,max_tokens:1024})).choices[0])==null?void 0:i.message)==null?void 0:l.content)==null?void 0:m.trim())??"No response.";return a.messages.push({role:"assistant",content:u}),{text:u,conversationId:s}}catch(t){return{error:t instanceof Error?t.message:String(t)}}}function p(e){var n;let r=e.question.trim()||"What do you see in this image? Describe it briefly.";return(n=e.contextText)!=null&&n.trim()&&(r+=`

[Context from the page:
${e.contextText.slice(0,2e3)}
]`),r}
