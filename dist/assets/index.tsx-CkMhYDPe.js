import{r as o,R as B,j as n,c as K}from"./client-Cw25wJni.js";function O(){const[e,r]=o.useState("idle"),[u,I]=o.useState(""),[v,f]=o.useState(null),[q,j]=o.useState(!1),[x,h]=o.useState(""),[g,d]=o.useState(""),[C,N]=o.useState(null),[A,U]=o.useState(null),[E,_]=o.useState(""),L=o.useCallback(()=>{r("idle"),I(""),f(null),j(!1),h(""),d(""),N(null),U(null),_(""),document.querySelectorAll(".live-lens-highlight").forEach(t=>t.remove())},[]),P=o.useCallback(()=>{r("selecting"),d(""),h(""),j(!1),f(null),document.querySelectorAll(".live-lens-highlight").forEach(t=>t.remove())},[]),$=o.useCallback(()=>{j(!0),f(null),r("asking"),document.querySelectorAll(".live-lens-highlight").forEach(t=>t.remove())},[]);B.useEffect(()=>{if(e!=="selecting")return;const t=l=>{var y,b;if(l.target.closest(`#${((y=document.getElementById("live-lens-root"))==null?void 0:y.id)||"live-lens-root"}`))return;l.preventDefault(),l.stopPropagation(),document.querySelectorAll(".live-lens-highlight").forEach(w=>w.remove());const c=l.target.getBoundingClientRect(),a=document.createElement("div");a.className="live-lens-highlight",a.style.cssText=`position: fixed; left: ${c.left}px; top: ${c.top}px; width: ${c.width}px; height: ${c.height}px;`,document.body.appendChild(a),f(c);const s=l.target,S=((b=s.innerText)==null?void 0:b.slice(0,1500))||s.alt||"";_(S),r("asking")};return document.addEventListener("click",t,!0),()=>document.removeEventListener("click",t,!0)},[e]);const M=o.useCallback((t,l)=>new Promise((i,c)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const s=window.devicePixelRatio||1,S=l.x*s,y=l.y*s,b=Math.min(l.width*s,a.width-S),w=Math.min(l.height*s,a.height-y),m=document.createElement("canvas");m.width=Math.max(1,b),m.height=Math.max(1,w);const F=m.getContext("2d");if(!F){c(new Error("No canvas context"));return}F.drawImage(a,S,y,b,w,0,0,m.width,m.height),i(m.toDataURL("image/png"))},a.onerror=()=>c(new Error("Failed to load image")),a.src=t}),[]),D=o.useCallback(async()=>{d(""),h(""),r("loading"),chrome.runtime.sendMessage({type:"LIVE_LENS_CAPTURE"},async t=>{if(t!=null&&t.error){d(t.error),r("asking");return}let l=t==null?void 0:t.dataUrl;if(!l){d("Could not capture screenshot."),r("asking");return}if(v&&v.width>0&&v.height>0)try{l=await M(l,v)}catch{d("Could not crop selection."),r("asking");return}U(l),chrome.runtime.sendMessage({type:"LIVE_LENS_ASK",imageDataUrl:l,question:u.trim()||"What do you see? Describe it briefly.",contextText:E||void 0,conversationId:C??void 0},i=>{if(i!=null&&i.error){d(i.error),r("result");return}h((i==null?void 0:i.text)??""),i!=null&&i.conversationId&&N(i.conversationId),r("result");try{const c=new SpeechSynthesisUtterance((i==null?void 0:i.text)??"");c.rate=.95,speechSynthesis.speak(c)}catch{}})})},[u,q,v,E,C,M]),V=o.useCallback(()=>{if(h(""),d(""),r("loading"),!A){d("No image in context."),r("result");return}chrome.runtime.sendMessage({type:"LIVE_LENS_ASK",imageDataUrl:A,question:u.trim()||"Anything else?",contextText:E||void 0,conversationId:C??void 0},t=>{if(t!=null&&t.error){d(t.error),r("result");return}h((t==null?void 0:t.text)??""),t!=null&&t.conversationId&&N(t.conversationId),r("result"),I("");try{const l=new SpeechSynthesisUtterance((t==null?void 0:t.text)??"");l.rate=.95,speechSynthesis.speak(l)}catch{}})},[u,A,E,C]);return e==="idle"?null:n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"live-lens-backdrop",onClick:L,"aria-hidden":!0}),n.jsxs("div",{className:"live-lens-overlay",children:[n.jsx("h3",{children:"Live Lens"}),e==="selecting"&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"live-lens-input-wrap",children:n.jsx("p",{style:{margin:"0 0 8px",color:"#aaa",fontSize:"13px"},children:"Click an element to describe, or use the whole page."})}),n.jsxs("div",{className:"live-lens-actions",children:[n.jsx("button",{type:"button",className:"live-lens-btn",onClick:$,children:"Use whole page"}),n.jsx("button",{type:"button",className:"live-lens-btn secondary",onClick:L,children:"Cancel"})]})]}),(e==="asking"||e==="loading"||e==="result")&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"live-lens-input-wrap",children:n.jsx("input",{type:"text",placeholder:"e.g. What's in this image? What does this button do?",value:u,onChange:t=>I(t.target.value),onKeyDown:t=>t.key==="Enter"&&D(),disabled:e==="loading"})}),n.jsxs("div",{className:"live-lens-actions",children:[x?n.jsx("button",{type:"button",className:"live-lens-btn",onClick:V,disabled:e==="loading"||!u.trim(),children:e==="loading"?"Asking…":"Follow-up"}):n.jsx("button",{type:"button",className:"live-lens-btn",onClick:D,disabled:e==="loading",children:e==="loading"?"Asking…":"Describe"}),n.jsx("button",{type:"button",className:"live-lens-btn secondary",onClick:P,children:"Reselect"}),n.jsx("button",{type:"button",className:"live-lens-btn secondary",onClick:L,children:"Close"})]}),(e==="loading"||x||g)&&n.jsxs("div",{className:`live-lens-response ${e==="loading"?"loading":""} ${g?"error":""}`,children:[e==="loading"&&!x&&!g&&"Asking AI…",g&&g,x&&!g&&x]})]})]})]})}const T="live-lens-root";function W(){let e=document.getElementById(T);return e||(e=document.createElement("div"),e.id=T,document.body.appendChild(e)),e}function z(){const e=W();e.hasAttribute("data-mounted")||(e.setAttribute("data-mounted","true"),K(e).render(n.jsx(O,{})))}function Q(){const e=document.getElementById(T);e&&(e.removeAttribute("data-mounted"),e.innerHTML="")}chrome.runtime.onMessage.addListener((e,r,u)=>(e.type==="LIVE_LENS_ACTIVATE"&&(z(),u({ok:!0})),!0));export{z as mount,Q as unmount};
